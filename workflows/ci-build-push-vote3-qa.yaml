# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# CI BUILD & PUSH - vote3 QA Environment (Canary)
# Generated by Opsera Code-to-Cloud Enterprise v0.905
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: "CI Build & Push (vote3-qa)"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        type: string
        required: true
      auto_promote:
        description: 'Auto-promote to Staging'
        type: boolean
        default: false

env:
  APP_NAME: vote3
  ENVIRONMENT: qa
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2

permissions:
  contents: write

jobs:
  deploy:
    name: "üöÄ Deploy to QA (Canary)"
    runs-on: ubuntu-latest
    outputs:
      deploy_success: ${{ steps.verify.outputs.success }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update Kustomization
        run: |
          cd .opsera-vote3/k8s/overlays/${{ env.ENVIRONMENT }}
          sed -i "s|newTag:.*|newTag: ${{ inputs.image_tag }}|g" kustomization.yaml

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .opsera-vote3/k8s/overlays/${{ env.ENVIRONMENT }}/
          git diff --cached --quiet || git commit -m "deploy(vote3-qa): Canary to ${{ inputs.image_tag }} [skip ci]"
          git pull --rebase origin main
          git push origin main

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Trigger ArgoCD Sync
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl annotate application "${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}" -n argocd argocd.argoproj.io/refresh=hard --overwrite

      - name: Wait for Canary (10min timeout)
        id: verify
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NAMESPACE="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          TIMEOUT=600
          ELAPSED=0

          echo "Waiting for all services in $NAMESPACE..."

          while [ $ELAPSED -lt $TIMEOUT ]; do
            VOTE_READY=$(kubectl get deployment vote -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
            RESULT_READY=$(kubectl get deployment result -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
            WORKER_READY=$(kubectl get deployment worker -n $NAMESPACE -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")

            echo "Vote: ${VOTE_READY:-0}, Result: ${RESULT_READY:-0}, Worker: ${WORKER_READY:-0}"

            if [ "${VOTE_READY:-0}" -ge 1 ] && [ "${RESULT_READY:-0}" -ge 1 ] && [ "${WORKER_READY:-0}" -ge 1 ]; then
              echo "‚úÖ All services ready!"
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 15
            ELAPSED=$((ELAPSED + 15))
          done
          echo "‚ö†Ô∏è Timeout waiting for services"
          echo "success=false" >> $GITHUB_OUTPUT

  notify-slack:
    name: "üì¢ Slack"
    needs: [deploy]
    if: always() && needs.deploy.outputs.deploy_success == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Failure
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: '{"text":"‚ùå QA Canary deployment failed for vote3"}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
