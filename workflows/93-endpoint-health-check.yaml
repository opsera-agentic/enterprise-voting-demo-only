# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  ENDPOINT HEALTH CHECK - Verify all application endpoints are accessible         ‚ïë
# ‚ïë  Generated by Opsera Code-to-Cloud v0.6                                          ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

name: "93-Endpoint Health Check"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to check"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - staging
  schedule:
    # Run every hour for monitoring
    - cron: '0 * * * *'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting2
  DOMAIN: agent.opsera.dev

permissions:
  contents: read

jobs:
  health-check:
    name: "üè• Health Check"
    runs-on: ubuntu-latest

    steps:
      - name: Check Endpoints
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "# üè• Endpoint Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`$ENV\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üåê HTTP Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status | Response Time | TLS |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|---------------|-----|" >> $GITHUB_STEP_SUMMARY

          OVERALL_STATUS="‚úÖ All Healthy"
          FAILED=0

          for SERVICE in vote result; do
            URL="https://${SERVICE}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}"

            # Perform health check with timing
            START=$(date +%s%N)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 "$URL" 2>/dev/null || echo "000")
            END=$(date +%s%N)
            DURATION=$(( (END - START) / 1000000 ))

            # Check TLS
            TLS_STATUS="‚ùì"
            if timeout 5 openssl s_client -connect "${SERVICE}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}:443" -servername "${SERVICE}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}" </dev/null 2>/dev/null | grep -q "Verify return code: 0"; then
              TLS_STATUS="‚úÖ Valid"
            else
              TLS_STATUS="‚ö†Ô∏è Issue"
            fi

            # Determine status icon
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="OK"
            if [ "$HTTP_CODE" == "000" ]; then
              STATUS_ICON="‚ùå"
              STATUS_TEXT="Unreachable"
              FAILED=$((FAILED + 1))
            elif [ "$HTTP_CODE" -ge 500 ]; then
              STATUS_ICON="‚ùå"
              STATUS_TEXT="Server Error"
              FAILED=$((FAILED + 1))
            elif [ "$HTTP_CODE" -ge 400 ]; then
              STATUS_ICON="‚ö†Ô∏è"
              STATUS_TEXT="Client Error"
            elif [ "$HTTP_CODE" -ge 300 ]; then
              STATUS_ICON="‚Ü™Ô∏è"
              STATUS_TEXT="Redirect"
            fi

            echo "| $SERVICE | [$URL]($URL) | $STATUS_ICON $HTTP_CODE ($STATUS_TEXT) | ${DURATION}ms | $TLS_STATUS |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ $FAILED -gt 0 ]; then
            OVERALL_STATUS="‚ùå $FAILED endpoint(s) unhealthy"
          fi

          echo "## üìä Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status**: $OVERALL_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # DNS Resolution Check
          echo "## üîç DNS Resolution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Hostname | IP Address |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------------|" >> $GITHUB_STEP_SUMMARY

          for SERVICE in vote result; do
            HOSTNAME="${SERVICE}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}"
            IP=$(dig +short $HOSTNAME 2>/dev/null | head -1 || echo "Unresolved")
            [ -z "$IP" ] && IP="Unresolved"
            echo "| \`$HOSTNAME\` | $IP |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fail workflow if endpoints are down
          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED endpoint(s) failed health check"
            exit 1
          fi

      - name: Check SSL Certificates
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "## üîí SSL Certificate Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Issuer | Valid From | Valid Until | Days Left |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------------|-------------|-----------|" >> $GITHUB_STEP_SUMMARY

          for SERVICE in vote result; do
            HOSTNAME="${SERVICE}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}"

            CERT_INFO=$(echo | timeout 10 openssl s_client -connect "${HOSTNAME}:443" -servername "$HOSTNAME" 2>/dev/null | openssl x509 -noout -dates -issuer 2>/dev/null)

            if [ -n "$CERT_INFO" ]; then
              ISSUER=$(echo "$CERT_INFO" | grep "issuer=" | sed 's/.*CN = //' | cut -d',' -f1 | cut -c1-30)
              NOT_BEFORE=$(echo "$CERT_INFO" | grep "notBefore=" | cut -d'=' -f2)
              NOT_AFTER=$(echo "$CERT_INFO" | grep "notAfter=" | cut -d'=' -f2)

              # Calculate days until expiry
              EXPIRY_EPOCH=$(date -d "$NOT_AFTER" +%s 2>/dev/null || date -j -f "%b %d %H:%M:%S %Y %Z" "$NOT_AFTER" +%s 2>/dev/null || echo "0")
              NOW_EPOCH=$(date +%s)
              DAYS_LEFT=$(( (EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))

              EXPIRY_ICON="‚úÖ"
              [ "$DAYS_LEFT" -lt 30 ] && EXPIRY_ICON="‚ö†Ô∏è"
              [ "$DAYS_LEFT" -lt 7 ] && EXPIRY_ICON="‚ùå"

              echo "| $SERVICE | $ISSUER | $NOT_BEFORE | $NOT_AFTER | $EXPIRY_ICON $DAYS_LEFT |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $SERVICE | ‚ùå Unable to fetch | - | - | - |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Performance Metrics
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "## ‚ö° Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | DNS | Connect | TLS | First Byte | Total |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|---------|-----|------------|-------|" >> $GITHUB_STEP_SUMMARY

          for SERVICE in vote result; do
            URL="https://${SERVICE}-${{ env.APP_NAME }}-${ENV}.${{ env.DOMAIN }}"

            TIMINGS=$(curl -s -o /dev/null -w "dns:%{time_namelookup}|conn:%{time_connect}|tls:%{time_appconnect}|first:%{time_starttransfer}|total:%{time_total}" --connect-timeout 10 --max-time 30 "$URL" 2>/dev/null || echo "dns:0|conn:0|tls:0|first:0|total:0")

            DNS=$(echo $TIMINGS | grep -oP 'dns:\K[0-9.]+' | awk '{printf "%.0fms", $1*1000}')
            CONN=$(echo $TIMINGS | grep -oP 'conn:\K[0-9.]+' | awk '{printf "%.0fms", $1*1000}')
            TLS=$(echo $TIMINGS | grep -oP 'tls:\K[0-9.]+' | awk '{printf "%.0fms", $1*1000}')
            FIRST=$(echo $TIMINGS | grep -oP 'first:\K[0-9.]+' | awk '{printf "%.0fms", $1*1000}')
            TOTAL=$(echo $TIMINGS | grep -oP 'total:\K[0-9.]+' | awk '{printf "%.0fms", $1*1000}')

            echo "| $SERVICE | $DNS | $CONN | $TLS | $FIRST | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Opsera Code-to-Cloud v0.6*" >> $GITHUB_STEP_SUMMARY
