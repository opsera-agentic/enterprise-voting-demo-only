# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DELETE ENVIRONMENT WORKFLOW - vote3
# Generated by Opsera Code-to-Cloud Enterprise v0.905
# RULE 117: ECR is shared - never delete on environment deletion
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "Delete Environment (vote3)"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to delete'
        type: string
        required: true
      confirm:
        description: 'Type DELETE to confirm'
        type: string
        required: true

env:
  APP_NAME: vote3
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  delete-environment:
    name: "ðŸ—‘ï¸ Delete ${{ inputs.environment }}"
    runs-on: ubuntu-latest
    if: inputs.confirm == 'DELETE'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Remove ArgoCD Finalizer & Delete
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          APP_NAME="${{ env.APP_NAME }}-${{ inputs.environment }}"

          # Remove finalizer to prevent stuck deletion
          kubectl patch application $APP_NAME -n argocd --type=merge -p '{"metadata":{"finalizers":null}}' 2>/dev/null || true

          # Delete ArgoCD application
          kubectl delete application $APP_NAME -n argocd 2>/dev/null || echo "ArgoCD app not found"

      - name: Delete K8s Namespace
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"

          kubectl delete namespace $NAMESPACE --ignore-not-found=true

      - name: Remove Config Files
        run: |
          rm -rf .opsera-vote3/k8s/overlays/${{ inputs.environment }}
          rm -rf .opsera-vote3/argocd/${{ inputs.environment }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore(vote3): Delete ${{ inputs.environment }} environment [skip ci]" || true
          git pull --rebase origin main
          git push origin main

      - name: Summary
        run: |
          echo "### ðŸ—‘ï¸ Environment Deleted: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Namespace: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ArgoCD App: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- Config Files: Removed" >> $GITHUB_STEP_SUMMARY
          echo "- ECR Repos: **Preserved** (shared)" >> $GITHUB_STEP_SUMMARY
