# Voting2 - Bootstrap Infrastructure
# Generated by Opsera Code-to-Cloud v0.6
# Uses OIDC for AWS authentication - NO ACCESS KEYS REQUIRED
# This workflow is IDEMPOTENT - safe to run multiple times

name: "00-Bootstrap Infrastructure"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  AWS_REGION: us-west-2
  APP_NAME: voting2
  ENVIRONMENT: dev
  TENANT: opsera

permissions:
  id-token: write   # Required for OIDC
  contents: write   # Required for git push

jobs:
  terraform:
    name: "Terraform ${{ github.event.inputs.action }}"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .opsera-voting2/terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        run: |
          terraform plan \
            -var-file=dev.tfvars \
            -out=tfplan \
            -input=false

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: |
          terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy \
            -var-file=dev.tfvars \
            -auto-approve

      - name: Export Terraform Outputs
        if: github.event.inputs.action == 'apply'
        id: tf_outputs
        run: |
          echo "REDIS_HOST=$(terraform output -raw redis_endpoint)" >> $GITHUB_OUTPUT
          echo "DATABASE_HOST=$(terraform output -raw rds_address)" >> $GITHUB_OUTPUT
          echo "ECR_VOTE=$(terraform output -raw ecr_vote_repository_url)" >> $GITHUB_OUTPUT
          echo "ECR_RESULT=$(terraform output -raw ecr_result_repository_url)" >> $GITHUB_OUTPUT
          echo "ECR_WORKER=$(terraform output -raw ecr_worker_repository_url)" >> $GITHUB_OUTPUT
          echo "VOTE_ROLE_ARN=$(terraform output -raw irsa_vote_role_arn)" >> $GITHUB_OUTPUT
          echo "RESULT_ROLE_ARN=$(terraform output -raw irsa_result_role_arn)" >> $GITHUB_OUTPUT
          echo "WORKER_ROLE_ARN=$(terraform output -raw irsa_worker_role_arn)" >> $GITHUB_OUTPUT

      - name: Update K8s Manifests with Terraform Outputs
        if: github.event.inputs.action == 'apply'
        run: |
          cd ../../

          # Update ConfigMap with cloud database endpoints
          sed -i "s|PLACEHOLDER_REDIS_HOST|${{ steps.tf_outputs.outputs.REDIS_HOST }}|g" \
            .opsera-voting2/k8s/base/configmap.yaml
          sed -i "s|PLACEHOLDER_DATABASE_HOST|${{ steps.tf_outputs.outputs.DATABASE_HOST }}|g" \
            .opsera-voting2/k8s/base/configmap.yaml

          # Update ServiceAccounts with IRSA role ARNs
          sed -i "s|PLACEHOLDER_VOTE_ROLE_ARN|${{ steps.tf_outputs.outputs.VOTE_ROLE_ARN }}|g" \
            .opsera-voting2/k8s/base/serviceaccounts.yaml
          sed -i "s|PLACEHOLDER_RESULT_ROLE_ARN|${{ steps.tf_outputs.outputs.RESULT_ROLE_ARN }}|g" \
            .opsera-voting2/k8s/base/serviceaccounts.yaml
          sed -i "s|PLACEHOLDER_WORKER_ROLE_ARN|${{ steps.tf_outputs.outputs.WORKER_ROLE_ARN }}|g" \
            .opsera-voting2/k8s/base/serviceaccounts.yaml

          # Update Kustomization with ECR URIs
          sed -i "s|PLACEHOLDER_ECR_VOTE|${{ steps.tf_outputs.outputs.ECR_VOTE }}|g" \
            .opsera-voting2/k8s/base/kustomization.yaml
          sed -i "s|PLACEHOLDER_ECR_RESULT|${{ steps.tf_outputs.outputs.ECR_RESULT }}|g" \
            .opsera-voting2/k8s/base/kustomization.yaml
          sed -i "s|PLACEHOLDER_ECR_WORKER|${{ steps.tf_outputs.outputs.ECR_WORKER }}|g" \
            .opsera-voting2/k8s/base/kustomization.yaml

          # Update overlay kustomization
          sed -i "s|PLACEHOLDER_ECR_VOTE|${{ steps.tf_outputs.outputs.ECR_VOTE }}|g" \
            .opsera-voting2/k8s/overlays/dev/kustomization.yaml
          sed -i "s|PLACEHOLDER_ECR_RESULT|${{ steps.tf_outputs.outputs.ECR_RESULT }}|g" \
            .opsera-voting2/k8s/overlays/dev/kustomization.yaml
          sed -i "s|PLACEHOLDER_ECR_WORKER|${{ steps.tf_outputs.outputs.ECR_WORKER }}|g" \
            .opsera-voting2/k8s/overlays/dev/kustomization.yaml

      - name: Commit Updated Manifests
        if: github.event.inputs.action == 'apply'
        run: |
          cd ../../
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .opsera-voting2/k8s/
          git commit -m "chore: update K8s manifests with Terraform outputs (IRSA) [skip ci]" || echo "No changes to commit"
          git push

  create-db-user:
    name: "Create RDS IAM User"
    runs-on: ubuntu-latest
    needs: terraform
    if: github.event.inputs.action == 'apply'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-db-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get RDS Master Password from Secrets Manager
        id: get_password
        run: |
          # Get the managed master password from Secrets Manager
          SECRET_ARN=$(aws rds describe-db-instances \
            --db-instance-identifier voting2-dev-postgres \
            --query 'DBInstances[0].MasterUserSecret.SecretArn' \
            --output text)

          MASTER_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id "$SECRET_ARN" \
            --query 'SecretString' \
            --output text | jq -r '.password')

          echo "::add-mask::$MASTER_PASSWORD"
          echo "MASTER_PASSWORD=$MASTER_PASSWORD" >> $GITHUB_OUTPUT

      - name: Create IAM Database User
        run: |
          # Get RDS endpoint
          RDS_HOST=$(aws rds describe-db-instances \
            --db-instance-identifier voting2-dev-postgres \
            --query 'DBInstances[0].Endpoint.Address' \
            --output text)

          # Install PostgreSQL client
          sudo apt-get update && sudo apt-get install -y postgresql-client

          # Create IAM user in PostgreSQL
          PGPASSWORD="${{ steps.get_password.outputs.MASTER_PASSWORD }}" psql \
            -h "$RDS_HOST" \
            -U postgres_admin \
            -d votes \
            -c "CREATE USER app_user WITH LOGIN; GRANT rds_iam TO app_user; GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO app_user; GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO app_user;" \
            || echo "User may already exist"

  setup-argocd:
    name: "Setup ArgoCD Application"
    runs-on: ubuntu-latest
    needs: [terraform, create-db-user]
    if: github.event.inputs.action == 'apply'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-argocd-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Update kubeconfig for Hub Cluster
        run: |
          # Configure kubeconfig for the ArgoCD hub cluster
          aws eks update-kubeconfig --name argocd-usw2 --region ${{ env.AWS_REGION }} --alias argocd-hub

          # Verify connection
          kubectl config use-context argocd-hub
          kubectl cluster-info

      - name: Apply ArgoCD Application
        run: |
          echo "Applying ArgoCD Application for GitOps deployment..."
          kubectl apply -f .opsera-voting2/argocd/application.yaml

          echo "ArgoCD Application created/updated:"
          kubectl get application voting2-dev -n argocd -o wide

      - name: Wait for ArgoCD Sync
        run: |
          echo "Waiting for ArgoCD to detect and sync the application..."

          # Wait for sync status (max 5 minutes)
          for i in {1..30}; do
            SYNC_STATUS=$(kubectl get application voting2-dev -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            HEALTH_STATUS=$(kubectl get application voting2-dev -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")

            echo "Attempt $i/30 - Sync: $SYNC_STATUS, Health: $HEALTH_STATUS"

            if [ "$SYNC_STATUS" == "Synced" ]; then
              echo "ArgoCD sync completed successfully!"
              break
            fi

            sleep 10
          done

          # Print final status
          echo ""
          echo "## ArgoCD Application Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application voting2-dev -n argocd -o yaml | head -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    needs: [terraform, create-db-user, setup-argocd]
    if: always() && github.event.inputs.action == 'apply'

    steps:
      - name: Print Summary
        run: |
          echo "## Voting2 Infrastructure Bootstrap Complete (IRSA Enabled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Authentication**: OIDC (No AWS Access Keys)" >> $GITHUB_STEP_SUMMARY
          echo "- **Database Auth**: IAM Authentication (No Passwords)" >> $GITHUB_STEP_SUMMARY
          echo "- **Pod Identity**: IRSA (IAM Roles for Service Accounts)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cloud Resources Created:" >> $GITHUB_STEP_SUMMARY
          echo "- ECR Repositories: vote, result, worker" >> $GITHUB_STEP_SUMMARY
          echo "- RDS PostgreSQL: voting2-dev-postgres (IAM Auth enabled)" >> $GITHUB_STEP_SUMMARY
          echo "- ElastiCache Redis: voting2-dev-redis" >> $GITHUB_STEP_SUMMARY
          echo "- IRSA Roles: vote, result, worker" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- Vote: https://vote-voting2-dev.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
          echo "- Result: https://result-voting2-dev.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run '20-ci-build-push' workflow to build and push images" >> $GITHUB_STEP_SUMMARY
          echo "2. ArgoCD will automatically deploy the application" >> $GITHUB_STEP_SUMMARY
