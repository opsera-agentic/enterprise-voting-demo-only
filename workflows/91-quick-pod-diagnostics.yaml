# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  QUICK POD DIAGNOSTICS - Fast troubleshooting for pod issues                     â•‘
# â•‘  Generated by Opsera Code-to-Cloud v0.6                                          â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "91-Quick Pod Diagnostics"

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to diagnose"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - vote
          - result
          - worker
      environment:
        description: "Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - staging

env:
  AWS_REGION: us-west-2
  APP_NAME: voting2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  id-token: write
  contents: read

jobs:
  pod-diagnostics:
    name: "ðŸ” Pod Diagnostics"
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ github.event.inputs.environment }}-github-actions
          role-session-name: pod-diag-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Generate Pod Report
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"
          SERVICE="${{ github.event.inputs.service }}"

          echo "# ðŸ” Pod Diagnostics Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`$NAMESPACE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Service Filter**: \`$SERVICE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine label selector
          LABEL_SELECTOR=""
          if [ "$SERVICE" != "all" ]; then
            LABEL_SELECTOR="-l app=$SERVICE"
          fi

          # Pod Overview
          echo "## ðŸ“‹ Pod Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NAMESPACE $LABEL_SELECTOR -o wide >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detailed Pod Status
          echo "## ðŸ”¬ Detailed Pod Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for POD in $(kubectl get pods -n $NAMESPACE $LABEL_SELECTOR -o jsonpath='{.items[*].metadata.name}'); do
            echo "### Pod: \`$POD\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Get pod status
            POD_JSON=$(kubectl get pod $POD -n $NAMESPACE -o json)
            PHASE=$(echo $POD_JSON | jq -r '.status.phase')
            READY=$(echo $POD_JSON | jq -r '.status.conditions[] | select(.type=="Ready") | .status')
            RESTARTS=$(echo $POD_JSON | jq -r '.status.containerStatuses[0].restartCount // 0')

            # Status indicator
            STATUS_ICON="âœ…"
            [ "$PHASE" != "Running" ] && STATUS_ICON="âš ï¸"
            [ "$READY" != "True" ] && STATUS_ICON="âŒ"

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Status | $STATUS_ICON $PHASE |" >> $GITHUB_STEP_SUMMARY
            echo "| Ready | $READY |" >> $GITHUB_STEP_SUMMARY
            echo "| Restarts | $RESTARTS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Container Status Details
            CONTAINER_STATE=$(echo $POD_JSON | jq -r '.status.containerStatuses[0].state | keys[0]')
            echo "**Container State**: \`$CONTAINER_STATE\`" >> $GITHUB_STEP_SUMMARY

            if [ "$CONTAINER_STATE" == "waiting" ]; then
              REASON=$(echo $POD_JSON | jq -r '.status.containerStatuses[0].state.waiting.reason')
              MESSAGE=$(echo $POD_JSON | jq -r '.status.containerStatuses[0].state.waiting.message // "N/A"')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Waiting Reason**: $REASON" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$MESSAGE" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY

            # Current Logs
            echo "<details><summary>ðŸ“œ Current Logs (last 50 lines)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs $POD -n $NAMESPACE --tail=50 2>&1 >> $GITHUB_STEP_SUMMARY || echo "No logs available"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Previous Logs (if restarted)
            if [ "$RESTARTS" -gt 0 ]; then
              echo "<details><summary>ðŸ“œ Previous Container Logs (crashed)</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              kubectl logs $POD -n $NAMESPACE --previous --tail=50 2>&1 >> $GITHUB_STEP_SUMMARY || echo "No previous logs"
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Pod Events
            echo "<details><summary>ðŸ“‹ Pod Events</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl describe pod $POD -n $NAMESPACE | grep -A20 "Events:" >> $GITHUB_STEP_SUMMARY || echo "No events"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          # Namespace Events
          echo "## ðŸ“‹ Recent Namespace Events" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n $NAMESPACE --sort-by='.lastTimestamp' | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
