# Voting2 - CI Build & Push
# Generated by Opsera Code-to-Cloud v0.6
# Uses OIDC for AWS authentication - NO ACCESS KEYS REQUIRED
# Builds all 3 services: vote, result, worker

name: "20-CI Build & Push"

on:
  push:
    branches:
      - main
    paths:
      - "vote/**"
      - "result/**"
      - "worker/**"
      - ".opsera-voting2/Dockerfiles/**"
  workflow_dispatch:
    inputs:
      services:
        description: "Services to build (comma-separated or 'all')"
        required: true
        default: "all"
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: voting2
  ENVIRONMENT: dev

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write   # Required for OIDC
  contents: write   # Required for git push
  actions: read

jobs:
  detect-changes:
    name: "Detect Changed Services"
    runs-on: ubuntu-latest
    outputs:
      vote: ${{ steps.changes.outputs.vote }}
      result: ${{ steps.changes.outputs.result }}
      worker: ${{ steps.changes.outputs.worker }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SERVICES="${{ github.event.inputs.services }}"
            if [[ "$SERVICES" == "all" ]]; then
              echo "vote=true" >> $GITHUB_OUTPUT
              echo "result=true" >> $GITHUB_OUTPUT
              echo "worker=true" >> $GITHUB_OUTPUT
            else
              echo "vote=$(echo $SERVICES | grep -q 'vote' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
              echo "result=$(echo $SERVICES | grep -q 'result' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
              echo "worker=$(echo $SERVICES | grep -q 'worker' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            fi
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            echo "vote=$(echo \"$CHANGED\" | grep -q '^vote/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "result=$(echo \"$CHANGED\" | grep -q '^result/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "worker=$(echo \"$CHANGED\" | grep -q '^worker/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi

  security-scan:
    name: "Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  build-vote:
    name: "Build Vote Service"
    runs-on: ubuntu-latest
    needs: [detect-changes, security-scan]
    if: needs.detect-changes.outputs.vote == 'true'
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      ecr_uri: ${{ steps.build.outputs.ecr_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-vote-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Vote Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .opsera-voting2/Dockerfiles/Dockerfile.vote
          push: true
          tags: |
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-vote:${{ github.sha }}
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-vote:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output Image Info
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "ecr_uri=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-vote" >> $GITHUB_OUTPUT

      - name: Grype Security Scan
        uses: anchore/scan-action@v3
        with:
          image: "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-vote:${{ github.sha }}"
          fail-build: false
          severity-cutoff: critical

  build-result:
    name: "Build Result Service"
    runs-on: ubuntu-latest
    needs: [detect-changes, security-scan]
    if: needs.detect-changes.outputs.result == 'true'
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      ecr_uri: ${{ steps.build.outputs.ecr_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-result-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Result Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .opsera-voting2/Dockerfiles/Dockerfile.result
          push: true
          tags: |
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-result:${{ github.sha }}
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-result:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output Image Info
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "ecr_uri=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-result" >> $GITHUB_OUTPUT

      - name: Grype Security Scan
        uses: anchore/scan-action@v3
        with:
          image: "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-result:${{ github.sha }}"
          fail-build: false
          severity-cutoff: critical

  build-worker:
    name: "Build Worker Service"
    runs-on: ubuntu-latest
    needs: [detect-changes, security-scan]
    if: needs.detect-changes.outputs.worker == 'true'
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      ecr_uri: ${{ steps.build.outputs.ecr_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: github-actions-worker-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Worker Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .opsera-voting2/Dockerfiles/Dockerfile.worker
          push: true
          tags: |
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-worker:${{ github.sha }}
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output Image Info
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "ecr_uri=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-worker" >> $GITHUB_OUTPUT

      - name: Grype Security Scan
        uses: anchore/scan-action@v3
        with:
          image: "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-worker:${{ github.sha }}"
          fail-build: false
          severity-cutoff: critical

  update-manifests:
    name: "Update K8s Manifests"
    runs-on: ubuntu-latest
    needs: [build-vote, build-result, build-worker]
    if: always() && (needs.build-vote.result == 'success' || needs.build-result.result == 'success' || needs.build-worker.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update Kustomization
        run: |
          cd .opsera-voting2/k8s/overlays/dev

          if [[ "${{ needs.build-vote.result }}" == "success" ]]; then
            kustomize edit set image PLACEHOLDER_VOTE_IMAGE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-vote:${{ github.sha }}
          fi

          if [[ "${{ needs.build-result.result }}" == "success" ]]; then
            kustomize edit set image PLACEHOLDER_RESULT_IMAGE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-result:${{ github.sha }}
          fi

          if [[ "${{ needs.build-worker.result }}" == "success" ]]; then
            kustomize edit set image PLACEHOLDER_WORKER_IMAGE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/voting2-dev-worker:${{ github.sha }}
          fi

      - name: Validate Kustomization
        run: |
          cd .opsera-voting2/k8s/overlays/dev
          kustomize build . > /dev/null

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .opsera-voting2/k8s/
          git commit -m "chore: update image tags to ${{ github.sha }} [skip ci]" || echo "No changes to commit"
          git push

  notify:
    name: "Send Notification"
    runs-on: ubuntu-latest
    needs: [build-vote, build-result, build-worker, update-manifests]
    if: always()

    steps:
      - name: Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Build Summary
        run: |
          echo "## Build Summary (OIDC Auth)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Image Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote | ${{ needs.build-vote.result || 'skipped' }} | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | ${{ needs.build-result.result || 'skipped' }} | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ needs.build-worker.result || 'skipped' }} | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security" >> $GITHUB_STEP_SUMMARY
          echo "- Authentication: OIDC (No AWS Keys)" >> $GITHUB_STEP_SUMMARY
          echo "- Database: IAM Authentication (No Passwords)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Vote: https://vote-voting2-dev.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
          echo "- Result: https://result-voting2-dev.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
