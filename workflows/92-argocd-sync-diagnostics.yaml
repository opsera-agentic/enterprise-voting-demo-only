# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ARGOCD SYNC DIAGNOSTICS - Debug and fix GitOps sync issues                      â•‘
# â•‘  Generated by Opsera Code-to-Cloud v0.6                                          â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "92-ArgoCD Sync Diagnostics"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "diagnose"
        type: choice
        options:
          - diagnose        # Just check status
          - force-refresh   # Hard refresh cache
          - force-sync      # Force sync with prune
          - full-reset      # Hard refresh + sync + prune
      environment:
        description: "Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - staging

env:
  AWS_REGION: us-west-2
  APP_NAME: voting2
  HUB_CLUSTER: argocd-usw2

permissions:
  id-token: write
  contents: read

jobs:
  argocd-diagnostics:
    name: "ðŸŽ¯ ArgoCD Diagnostics"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ github.event.inputs.environment }}-github-actions
          role-session-name: argocd-diag-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Diagnose ArgoCD Application
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "# ðŸŽ¯ ArgoCD Sync Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application**: \`$APP\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: \`${{ github.event.inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if ! kubectl get application $APP -n argocd &>/dev/null; then
            echo "âŒ **Application not found**: \`$APP\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Get current status
          APP_JSON=$(kubectl get application $APP -n argocd -o json)

          SYNC_STATUS=$(echo $APP_JSON | jq -r '.status.sync.status // "Unknown"')
          HEALTH_STATUS=$(echo $APP_JSON | jq -r '.status.health.status // "Unknown"')
          REVISION=$(echo $APP_JSON | jq -r '.status.sync.revision // "N/A"' | cut -c1-7)
          REPO=$(echo $APP_JSON | jq -r '.spec.source.repoURL')
          PATH=$(echo $APP_JSON | jq -r '.spec.source.path')

          echo "## ðŸ“Š Current Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY

          SYNC_ICON="âœ…"
          [ "$SYNC_STATUS" != "Synced" ] && SYNC_ICON="âš ï¸"
          [ "$SYNC_STATUS" == "Unknown" ] && SYNC_ICON="â“"
          echo "| **Sync Status** | $SYNC_ICON $SYNC_STATUS |" >> $GITHUB_STEP_SUMMARY

          HEALTH_ICON="âœ…"
          [ "$HEALTH_STATUS" != "Healthy" ] && HEALTH_ICON="âš ï¸"
          [ "$HEALTH_STATUS" == "Degraded" ] && HEALTH_ICON="âŒ"
          echo "| **Health Status** | $HEALTH_ICON $HEALTH_STATUS |" >> $GITHUB_STEP_SUMMARY

          echo "| **Revision** | \`$REVISION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | \`$REPO\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Path** | \`$PATH\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for conditions/errors
          CONDITIONS=$(echo $APP_JSON | jq -r '.status.conditions // []')
          if [ "$CONDITIONS" != "[]" ] && [ "$CONDITIONS" != "null" ]; then
            echo "## âš ï¸ Conditions/Errors" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo $APP_JSON | jq -r '.status.conditions[] | "### \(.type)\n\n\(.message)\n"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Operation State
          OP_STATE=$(echo $APP_JSON | jq -r '.status.operationState // {}')
          if [ "$OP_STATE" != "{}" ]; then
            OP_PHASE=$(echo $OP_STATE | jq -r '.phase // "N/A"')
            OP_MESSAGE=$(echo $OP_STATE | jq -r '.message // "N/A"')
            OP_STARTED=$(echo $OP_STATE | jq -r '.startedAt // "N/A"' | cut -c1-19)
            OP_FINISHED=$(echo $OP_STATE | jq -r '.finishedAt // "N/A"' | cut -c1-19)

            echo "## ðŸ”„ Last Operation" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | $OP_PHASE |" >> $GITHUB_STEP_SUMMARY
            echo "| Started | $OP_STARTED |" >> $GITHUB_STEP_SUMMARY
            echo "| Finished | $OP_FINISHED |" >> $GITHUB_STEP_SUMMARY

            if [ "$OP_MESSAGE" != "N/A" ] && [ "$OP_MESSAGE" != "null" ] && [ -n "$OP_MESSAGE" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Message**:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$OP_MESSAGE" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Resource Sync Status
          echo "## ðŸ“¦ Resource Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Kind | Name | Sync | Health |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|--------|" >> $GITHUB_STEP_SUMMARY

          echo $APP_JSON | jq -r '
            .status.resources[]? |
            "\(.kind)|\(.name)|\(.status // "Unknown")|\(.health.status // "Unknown")"
          ' | while IFS='|' read KIND NAME STATUS HEALTH; do
            SYNC_ICON="âœ…"
            [ "$STATUS" != "Synced" ] && SYNC_ICON="âš ï¸"
            HEALTH_ICON="âœ…"
            [ "$HEALTH" != "Healthy" ] && HEALTH_ICON="âš ï¸"
            [ "$HEALTH" == "Degraded" ] && HEALTH_ICON="âŒ"
            echo "| $KIND | \`$NAME\` | $SYNC_ICON $STATUS | $HEALTH_ICON $HEALTH |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Validate Local Kustomize
        run: |
          ENV="${{ github.event.inputs.environment }}"
          OVERLAY_PATH=".opsera-${{ env.APP_NAME }}/k8s/overlays/$ENV"

          echo "## ðŸ”§ Local Kustomize Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Path**: \`$OVERLAY_PATH\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "$OVERLAY_PATH" ]; then
            if kustomize build $OVERLAY_PATH > /tmp/manifest.yaml 2>&1; then
              RESOURCES=$(grep -c '^kind:' /tmp/manifest.yaml || echo "0")
              echo "âœ… **Kustomize build successful** - $RESOURCES resources" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Kustomize build FAILED**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat /tmp/manifest.yaml >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Path not found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Force Hard Refresh
        if: contains(fromJSON('["force-refresh", "full-reset"]'), github.event.inputs.action)
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "## ðŸ”„ Force Hard Refresh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          kubectl annotate application $APP -n argocd argocd.argoproj.io/refresh=hard --overwrite
          echo "âœ… Hard refresh annotation applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Waiting 15 seconds for cache clear..." >> $GITHUB_STEP_SUMMARY
          sleep 15

      - name: Force Sync
        if: contains(fromJSON('["force-sync", "full-reset"]'), github.event.inputs.action)
        run: |
          APP="${{ env.APP_NAME }}-${{ github.event.inputs.environment }}"

          echo "## ðŸ”„ Force Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          kubectl patch application $APP -n argocd \
            --type merge \
            -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true,"syncStrategy":{"apply":{"force":true}}}}}'

          echo "âœ… Sync operation triggered with prune and force" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "Waiting 30 seconds for sync..." >> $GITHUB_STEP_SUMMARY
          sleep 30

          # Get new status
          NEW_STATUS=$(kubectl get application $APP -n argocd -o jsonpath='{.status.sync.status}')
          NEW_HEALTH=$(kubectl get application $APP -n argocd -o jsonpath='{.status.health.status}')

          echo "### Post-Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sync | $NEW_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Health | $NEW_HEALTH |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Recommendations
        run: |
          echo "## ðŸ’¡ Troubleshooting Tips" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Issue | Solution |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Unknown | Run with \`force-refresh\` action |" >> $GITHUB_STEP_SUMMARY
          echo "| Kustomize Error | Fix error in repo, then \`full-reset\` |" >> $GITHUB_STEP_SUMMARY
          echo "| OutOfSync | Run with \`force-sync\` action |" >> $GITHUB_STEP_SUMMARY
          echo "| ImagePullBackOff | Check ECR image exists and tags match |" >> $GITHUB_STEP_SUMMARY
          echo "| Degraded Health | Check pod logs with \`91-quick-pod-diagnostics\` |" >> $GITHUB_STEP_SUMMARY
