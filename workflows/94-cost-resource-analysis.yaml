# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  COST & RESOURCE ANALYSIS - AWS resource inventory and cost estimation           â•‘
# â•‘  Generated by Opsera Code-to-Cloud v0.6                                          â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "94-Cost & Resource Analysis"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to analyze"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - staging
          - all
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

env:
  AWS_REGION: us-west-2
  APP_NAME: voting2

permissions:
  id-token: write
  contents: read

jobs:
  cost-analysis:
    name: "ðŸ’° Cost & Resource Analysis"
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ github.event.inputs.environment || 'dev' }}-github-actions
          role-session-name: cost-analysis-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Generate Resource Inventory
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "# ðŸ’° Cost & Resource Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: \`$ENV\`" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Generated**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Resource pricing estimates (approximate)
          echo "## ðŸ“Š Resource Inventory & Cost Estimates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: Costs are estimates based on on-demand pricing in us-west-2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Analyze EKS Clusters
        run: |
          echo "### â˜¸ï¸ EKS Clusters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | Version | Node Groups | Nodes | Est. Monthly Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|-------------|-------|-------------------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_EKS_COST=0

          for CLUSTER in argocd-usw2 opsera-usw2-np; do
            if aws eks describe-cluster --name $CLUSTER &>/dev/null; then
              VERSION=$(aws eks describe-cluster --name $CLUSTER --query 'cluster.version' --output text)

              # Count node groups and nodes
              NG_COUNT=$(aws eks list-nodegroups --cluster-name $CLUSTER --query 'length(nodegroups)' --output text 2>/dev/null || echo "0")

              NODE_COUNT=0
              for NG in $(aws eks list-nodegroups --cluster-name $CLUSTER --query 'nodegroups[]' --output text 2>/dev/null); do
                DESIRED=$(aws eks describe-nodegroup --cluster-name $CLUSTER --nodegroup-name $NG --query 'nodegroup.scalingConfig.desiredSize' --output text 2>/dev/null || echo "0")
                NODE_COUNT=$((NODE_COUNT + DESIRED))
              done

              # EKS control plane: $0.10/hour = ~$73/month
              # t3.medium nodes: ~$30/month each
              CLUSTER_COST=$((73 + (NODE_COUNT * 30)))
              TOTAL_EKS_COST=$((TOTAL_EKS_COST + CLUSTER_COST))

              echo "| \`$CLUSTER\` | $VERSION | $NG_COUNT | $NODE_COUNT | ~\$${CLUSTER_COST}/mo |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total EKS**: ~\$${TOTAL_EKS_COST}/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "EKS_COST=$TOTAL_EKS_COST" >> $GITHUB_ENV

      - name: Analyze RDS Databases
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "### ðŸ—„ï¸ RDS Databases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Instance | Engine | Class | Storage | Multi-AZ | Est. Monthly Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-------|---------|----------|-------------------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_RDS_COST=0
          DB_ID="${{ env.APP_NAME }}-${ENV}-postgres"

          if aws rds describe-db-instances --db-instance-identifier $DB_ID &>/dev/null; then
            DB_INFO=$(aws rds describe-db-instances --db-instance-identifier $DB_ID --query 'DBInstances[0]' --output json)

            ENGINE=$(echo $DB_INFO | jq -r '.Engine')
            VERSION=$(echo $DB_INFO | jq -r '.EngineVersion')
            CLASS=$(echo $DB_INFO | jq -r '.DBInstanceClass')
            STORAGE=$(echo $DB_INFO | jq -r '.AllocatedStorage')
            MULTI_AZ=$(echo $DB_INFO | jq -r '.MultiAZ')

            # Cost estimation
            # db.t3.micro: ~$13/month, db.t3.small: ~$26/month, db.t3.medium: ~$52/month
            # Storage: ~$0.115/GB/month
            case $CLASS in
              "db.t3.micro") COMPUTE_COST=13 ;;
              "db.t3.small") COMPUTE_COST=26 ;;
              "db.t3.medium") COMPUTE_COST=52 ;;
              "db.t3.large") COMPUTE_COST=104 ;;
              *) COMPUTE_COST=50 ;;
            esac

            STORAGE_COST=$(echo "$STORAGE * 0.115" | bc 2>/dev/null || echo $((STORAGE / 10)))

            [ "$MULTI_AZ" == "true" ] && COMPUTE_COST=$((COMPUTE_COST * 2))

            DB_COST=$((COMPUTE_COST + STORAGE_COST))
            TOTAL_RDS_COST=$((TOTAL_RDS_COST + DB_COST))

            MULTI_AZ_ICON="âŒ"
            [ "$MULTI_AZ" == "true" ] && MULTI_AZ_ICON="âœ…"

            echo "| \`$DB_ID\` | $ENGINE $VERSION | $CLASS | ${STORAGE}GB | $MULTI_AZ_ICON | ~\$${DB_COST}/mo |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| \`$DB_ID\` | - | Not Found | - | - | \$0 |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total RDS**: ~\$${TOTAL_RDS_COST}/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "RDS_COST=$TOTAL_RDS_COST" >> $GITHUB_ENV

      - name: Analyze ElastiCache
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "### ðŸ”´ ElastiCache Redis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | Engine | Node Type | Nodes | Est. Monthly Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----------|-------|-------------------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_CACHE_COST=0
          CLUSTER_ID="${{ env.APP_NAME }}-${ENV}-redis"

          if aws elasticache describe-cache-clusters --cache-cluster-id $CLUSTER_ID &>/dev/null; then
            CACHE_INFO=$(aws elasticache describe-cache-clusters --cache-cluster-id $CLUSTER_ID --query 'CacheClusters[0]' --output json)

            ENGINE=$(echo $CACHE_INFO | jq -r '.Engine')
            VERSION=$(echo $CACHE_INFO | jq -r '.EngineVersion')
            NODE_TYPE=$(echo $CACHE_INFO | jq -r '.CacheNodeType')
            NODES=$(echo $CACHE_INFO | jq -r '.NumCacheNodes')

            # Cost estimation
            # cache.t3.micro: ~$12/month, cache.t3.small: ~$24/month
            case $NODE_TYPE in
              "cache.t3.micro") NODE_COST=12 ;;
              "cache.t3.small") NODE_COST=24 ;;
              "cache.t3.medium") NODE_COST=48 ;;
              *) NODE_COST=25 ;;
            esac

            CACHE_COST=$((NODE_COST * NODES))
            TOTAL_CACHE_COST=$((TOTAL_CACHE_COST + CACHE_COST))

            echo "| \`$CLUSTER_ID\` | $ENGINE $VERSION | $NODE_TYPE | $NODES | ~\$${CACHE_COST}/mo |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| \`$CLUSTER_ID\` | - | Not Found | - | \$0 |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total ElastiCache**: ~\$${TOTAL_CACHE_COST}/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CACHE_COST=$TOTAL_CACHE_COST" >> $GITHUB_ENV

      - name: Analyze ECR Repositories
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"

          echo "### ðŸ³ ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Images | Total Size | Est. Monthly Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|------------|-------------------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_ECR_SIZE=0
          TOTAL_ECR_COST=0

          for SERVICE in vote result worker; do
            REPO="${{ env.APP_NAME }}-${ENV}-${SERVICE}"

            if aws ecr describe-repositories --repository-names $REPO &>/dev/null; then
              # Get total size
              IMAGES=$(aws ecr describe-images --repository-name $REPO --query 'imageDetails' --output json 2>/dev/null || echo "[]")
              IMAGE_COUNT=$(echo $IMAGES | jq 'length')
              TOTAL_BYTES=$(echo $IMAGES | jq '[.[].imageSizeInBytes] | add // 0')
              SIZE_GB=$(echo "scale=2; $TOTAL_BYTES / 1024 / 1024 / 1024" | bc 2>/dev/null || echo "0")

              # ECR: $0.10/GB/month
              REPO_COST=$(echo "scale=2; $SIZE_GB * 0.10" | bc 2>/dev/null || echo "0")
              TOTAL_ECR_COST=$(echo "scale=2; $TOTAL_ECR_COST + $REPO_COST" | bc 2>/dev/null || echo "0")

              echo "| \`$REPO\` | $IMAGE_COUNT | ${SIZE_GB}GB | ~\$${REPO_COST}/mo |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| \`$REPO\` | Not Found | - | \$0 |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total ECR**: ~\$${TOTAL_ECR_COST}/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ECR_COST=${TOTAL_ECR_COST%.*}" >> $GITHUB_ENV

      - name: Analyze Load Balancers
        run: |
          echo "### âš–ï¸ Load Balancers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Name | Type | Scheme | Est. Monthly Cost |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|-------------------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_LB_COST=0

          # ALB: ~$16/month base + LCU charges
          # NLB: ~$6/month base + LCU charges
          aws elbv2 describe-load-balancers --query 'LoadBalancers[*]' --output json 2>/dev/null | jq -r '.[] | "\(.LoadBalancerName)|\(.Type)|\(.Scheme)"' | while IFS='|' read NAME TYPE SCHEME; do
            case $TYPE in
              "application") LB_COST=22 ;;
              "network") LB_COST=10 ;;
              *) LB_COST=15 ;;
            esac
            echo "| \`$NAME\` | $TYPE | $SCHEME | ~\$${LB_COST}/mo |" >> $GITHUB_STEP_SUMMARY
            echo $LB_COST >> /tmp/lb_costs.txt
          done

          if [ -f /tmp/lb_costs.txt ]; then
            TOTAL_LB_COST=$(awk '{sum+=$1} END {print sum}' /tmp/lb_costs.txt 2>/dev/null || echo "0")
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Load Balancers**: ~\$${TOTAL_LB_COST:-0}/month" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "LB_COST=${TOTAL_LB_COST:-0}" >> $GITHUB_ENV

      - name: Generate Cost Summary
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’µ Total Cost Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          EKS=${EKS_COST:-0}
          RDS=${RDS_COST:-0}
          CACHE=${CACHE_COST:-0}
          ECR=${ECR_COST:-0}
          LB=${LB_COST:-0}

          TOTAL=$((EKS + RDS + CACHE + ECR + LB))

          echo "| Service | Monthly Cost | % of Total |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------------|------------|" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL -gt 0 ]; then
            EKS_PCT=$((EKS * 100 / TOTAL))
            RDS_PCT=$((RDS * 100 / TOTAL))
            CACHE_PCT=$((CACHE * 100 / TOTAL))
            ECR_PCT=$((ECR * 100 / TOTAL))
            LB_PCT=$((LB * 100 / TOTAL))
          else
            EKS_PCT=0; RDS_PCT=0; CACHE_PCT=0; ECR_PCT=0; LB_PCT=0
          fi

          echo "| â˜¸ï¸ EKS | \$${EKS} | ${EKS_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ RDS | \$${RDS} | ${RDS_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ ElastiCache | \$${CACHE} | ${CACHE_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ ECR | \$${ECR} | ${ECR_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| âš–ï¸ Load Balancers | \$${LB} | ${LB_PCT}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **TOTAL** | **\$${TOTAL}** | **100%** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Cost breakdown chart (ASCII)
          echo "### ðŸ“Š Cost Distribution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          printf "EKS          [%-20s] %d%%\n" "$(printf 'â–ˆ%.0s' $(seq 1 $((EKS_PCT / 5 + 1))))" $EKS_PCT >> $GITHUB_STEP_SUMMARY
          printf "RDS          [%-20s] %d%%\n" "$(printf 'â–ˆ%.0s' $(seq 1 $((RDS_PCT / 5 + 1))))" $RDS_PCT >> $GITHUB_STEP_SUMMARY
          printf "ElastiCache  [%-20s] %d%%\n" "$(printf 'â–ˆ%.0s' $(seq 1 $((CACHE_PCT / 5 + 1))))" $CACHE_PCT >> $GITHUB_STEP_SUMMARY
          printf "ECR          [%-20s] %d%%\n" "$(printf 'â–ˆ%.0s' $(seq 1 $((ECR_PCT / 5 + 1))))" $ECR_PCT >> $GITHUB_STEP_SUMMARY
          printf "Load Bal.    [%-20s] %d%%\n" "$(printf 'â–ˆ%.0s' $(seq 1 $((LB_PCT / 5 + 1))))" $LB_PCT >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Recommendations
          echo "## ðŸ’¡ Cost Optimization Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $EKS -gt 200 ]; then
            echo "- Consider using Spot instances for non-critical workloads (up to 90% savings)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ $RDS -gt 100 ]; then
            echo "- Consider Reserved Instances for RDS (up to 60% savings)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- Enable ECR lifecycle policies to clean up old images" >> $GITHUB_STEP_SUMMARY
          echo "- Review and right-size underutilized resources" >> $GITHUB_STEP_SUMMARY
          echo "- Use AWS Savings Plans for predictable workloads" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Opsera Code-to-Cloud v0.6*" >> $GITHUB_STEP_SUMMARY
