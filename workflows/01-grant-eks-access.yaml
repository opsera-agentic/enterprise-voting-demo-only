# Grant Cluster Access to GitHub Actions Role
# Adds the GitHub Actions IAM role to EKS cluster aws-auth ConfigMaps
# Supports: Hub cluster + Spoke clusters
#
# Generated by Opsera Code-to-Cloud v0.6

name: "01-Grant Cluster Access"

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - apply
      clusters:
        description: "Which clusters to grant access to"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - hub-only
          - spokes-only

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_NP: opsera-usw2-np
  SPOKE_PROD: opsera-usw2-prod
  APP_NAME: voting2
  ENVIRONMENT: dev

permissions:
  id-token: write
  contents: read

jobs:
  grant-access:
    name: "Grant Cluster Access"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/voting2-dev-github-actions
          role-session-name: grant-access-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Grant Access to Clusters
        env:
          ACTION: ${{ github.event.inputs.action }}
          CLUSTER_SELECTION: ${{ github.event.inputs.clusters }}
        run: |
          ROLE_ARN="arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}-github-actions"
          USERNAME="github-actions-${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          echo "# Cluster Access Grant Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Role ARN**: \`${ROLE_ARN}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: \`${ACTION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Clusters**: \`${CLUSTER_SELECTION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build cluster list
          CLUSTERS=""
          if [ "$CLUSTER_SELECTION" == "all" ] || [ "$CLUSTER_SELECTION" == "hub-only" ]; then
            CLUSTERS="${{ env.HUB_CLUSTER }}"
          fi
          if [ "$CLUSTER_SELECTION" == "all" ] || [ "$CLUSTER_SELECTION" == "spokes-only" ]; then
            CLUSTERS="$CLUSTERS ${{ env.SPOKE_NP }} ${{ env.SPOKE_PROD }}"
          fi

          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | Access | Role Status | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

          MANUAL_CLUSTERS=""

          for CLUSTER in $CLUSTERS; do
            echo "Processing cluster: $CLUSTER"

            aws eks update-kubeconfig --name "$CLUSTER" --region ${{ env.AWS_REGION }} 2>/dev/null || true

            if kubectl get namespaces --request-timeout=10s >/dev/null 2>&1; then
              echo "Connected to $CLUSTER"

              if kubectl get configmap aws-auth -n kube-system -o yaml 2>/dev/null | grep -q "${ROLE_ARN}"; then
                echo "| \`$CLUSTER\` | Yes | Already configured | - |" >> $GITHUB_STEP_SUMMARY
              else
                if [ "$ACTION" == "preview" ]; then
                  echo "| \`$CLUSTER\` | Yes | Not configured | Preview |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "Adding role to $CLUSTER..."
                  CURRENT=$(kubectl get configmap aws-auth -n kube-system -o jsonpath='{.data.mapRoles}')
                  NEW_ENTRY="- rolearn: ${ROLE_ARN}
  username: ${USERNAME}
  groups:
    - system:masters"
                  kubectl create configmap aws-auth-backup -n kube-system --from-literal=mapRoles="$CURRENT" --dry-run=client -o yaml | kubectl apply -f - 2>/dev/null || true
                  UPDATED="${CURRENT}
${NEW_ENTRY}"
                  kubectl patch configmap aws-auth -n kube-system -p "{\"data\":{\"mapRoles\":\"${UPDATED//$'\n'/\\n}\"}}" && \
                    echo "| \`$CLUSTER\` | Yes | Added | Applied |" >> $GITHUB_STEP_SUMMARY || \
                    echo "| \`$CLUSTER\` | Yes | Failed | Error |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "Cannot access $CLUSTER"
              echo "| \`$CLUSTER\` | No | - | Manual required |" >> $GITHUB_STEP_SUMMARY
              MANUAL_CLUSTERS="$MANUAL_CLUSTERS $CLUSTER"
            fi
          done

          if [ -n "$MANUAL_CLUSTERS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Manual Setup Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run these commands locally for inaccessible clusters:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for CLUSTER in $MANUAL_CLUSTERS; do
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "aws eks update-kubeconfig --name $CLUSTER --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
              echo "eksctl create iamidentitymapping --cluster $CLUSTER --region ${{ env.AWS_REGION }} --arn ${ROLE_ARN} --username ${USERNAME} --group system:masters" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

          if [ "$ACTION" == "preview" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To apply, re-run with action: apply**" >> $GITHUB_STEP_SUMMARY
          fi
