# CI/CD Build & Deploy - voting01 DEV10
name: "CI Build (voting01-dev10)"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Existing image tag to deploy (skip build)'
        required: false
        default: ''

env:
  APP_NAME: voting01
  ENVIRONMENT: dev10
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2

permissions:
  contents: write
  id-token: write

jobs:
  build-and-push:
    name: "Build & Push"
    runs-on: ubuntu-latest
    if: inputs.image_tag == ''
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $(aws sts get-caller-identity --query Account --output text).dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

      - name: Generate Tag
        id: tag
        run: |
          TAG="$(echo ${GITHUB_SHA} | cut -c1-7)-$(date +%Y%m%d%H%M%S)"
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Image tag: ${TAG}" >> $GITHUB_STEP_SUMMARY

      - name: Build & Push Images
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          TAG="${{ steps.tag.outputs.image_tag }}"
          for SERVICE in vote result worker; do
            echo "Building ${SERVICE}..."
            docker build -t ${ECR}/opsera/${{ env.APP_NAME }}-${SERVICE}:${TAG} ./${SERVICE}/
            docker push ${ECR}/opsera/${{ env.APP_NAME }}-${SERVICE}:${TAG}
            echo "Pushed: ${ECR}/opsera/${{ env.APP_NAME }}-${SERVICE}:${TAG}" >> $GITHUB_STEP_SUMMARY
          done

  deploy:
    name: "Deploy DEV10"
    needs: [build-and-push]
    if: always() && (needs.build-and-push.result == 'success' || inputs.image_tag != '')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine Image Tag
        id: img
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ needs.build-and-push.outputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Kustomization
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          TAG="${{ steps.img.outputs.tag }}"
          cd .opsera-voting01/k8s/overlays/${{ env.ENVIRONMENT }}
          sed -i "s|newTag:.*|newTag: ${TAG}|g" kustomization.yaml

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .opsera-voting01/k8s/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml
          git diff --cached --quiet || git commit -m "deploy(voting01-dev10): Update to image ${{ steps.img.outputs.tag }} [skip ci]"
          git pull --rebase origin main
          git push origin main

      - name: Trigger ArgoCD Sync
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl annotate application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd argocd.argoproj.io/refresh=hard --overwrite || true

      - name: Wait for Rollout
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          for i in {1..30}; do
            READY=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c "Running" || echo "0")
            echo "Running pods: $READY/3"
            [ "$READY" -ge 3 ] && exit 0
            sleep 10
          done
          echo "Some pods may still be starting" >> $GITHUB_STEP_SUMMARY

      - name: Verify & Restart Pods for IRSA
        run: |
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### Deleting pods to ensure fresh IRSA token injection" >> $GITHUB_STEP_SUMMARY
          kubectl delete pods --all -n $NS 2>/dev/null || true
          sleep 30
          echo "### Pod Status (post-restart)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NS -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Deployment Summary
        run: |
          echo "# Deployment Complete: voting01-dev10" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote | https://vote-voting01-dev10.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | https://result-voting01-dev10.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
