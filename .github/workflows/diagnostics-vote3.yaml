# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DIAGNOSTICS WORKFLOW - vote3
# Generated by Opsera Code-to-Cloud Enterprise v0.905
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "Diagnostics (vote3)"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        type: choice
        options: [dev, qa, staging]
        default: dev
      diagnostic_type:
        description: 'Diagnostic type'
        type: choice
        options: [full-pipeline, pod-logs, argocd-debug, force-sync]
        default: full-pipeline

env:
  APP_NAME: vote3
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2

jobs:
  diagnose:
    name: "ðŸ”¬ Diagnostics"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Full Pipeline Diagnostics
        if: inputs.diagnostic_type == 'full-pipeline'
        run: |
          echo "### ðŸ“Š Full Pipeline Diagnostics" >> $GITHUB_STEP_SUMMARY
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"

          # ECR Check
          echo "#### ðŸ“¦ ECR Repositories" >> $GITHUB_STEP_SUMMARY
          for svc in vote result worker; do
            REPO="${{ env.APP_NAME }}-${{ inputs.environment }}-${svc}"
            if aws ecr describe-repositories --repository-names $REPO &>/dev/null; then
              echo "- âœ… ${REPO}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ ${REPO} NOT FOUND" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # K8s Check
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "#### ðŸŽ¯ Kubernetes Resources" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NAMESPACE -o wide 2>/dev/null || echo "Namespace not found"
          echo '```' >> $GITHUB_STEP_SUMMARY

          # ArgoCD Check
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "#### ðŸ”„ ArgoCD Status" >> $GITHUB_STEP_SUMMARY
          SYNC=$(kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
          HEALTH=$(kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")
          echo "- Sync: **${SYNC}**" >> $GITHUB_STEP_SUMMARY
          echo "- Health: **${HEALTH}**" >> $GITHUB_STEP_SUMMARY

      - name: Pod Logs
        if: inputs.diagnostic_type == 'pod-logs'
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"

          echo "### ðŸ“‹ Pod Logs" >> $GITHUB_STEP_SUMMARY
          for pod in $(kubectl get pods -n $NAMESPACE -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "#### $pod" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs $pod -n $NAMESPACE --tail=50 2>/dev/null || echo "No logs"
            echo '```' >> $GITHUB_STEP_SUMMARY
          done

      - name: Force Sync
        if: inputs.diagnostic_type == 'force-sync'
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          APP_NAME="${{ env.APP_NAME }}-${{ inputs.environment }}"

          kubectl annotate application $APP_NAME -n argocd argocd.argoproj.io/refresh=hard --overwrite
          echo "âœ… Force sync triggered for $APP_NAME" >> $GITHUB_STEP_SUMMARY
