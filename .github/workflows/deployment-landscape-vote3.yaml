# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOYMENT LANDSCAPE - vote3
# Generated by Opsera Code-to-Cloud Enterprise v0.905
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "Deployment Landscape (vote3)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

env:
  APP_NAME: vote3
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2

jobs:
  collect-metrics:
    name: "ðŸ“Š Collect Metrics"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, qa, staging]
    outputs:
      dev_status: ${{ steps.metrics.outputs.dev_status }}
      qa_status: ${{ steps.metrics.outputs.qa_status }}
      staging_status: ${{ steps.metrics.outputs.staging_status }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Metrics
        id: metrics
        run: |
          ENV="${{ matrix.environment }}"
          NAMESPACE="${{ env.APP_NAME }}-${ENV}"

          # ArgoCD status
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          SYNC=$(kubectl get application ${{ env.APP_NAME }}-${ENV} -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")

          # Pod count
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          PODS=$(kubectl get pods -n $NAMESPACE --no-headers 2>/dev/null | wc -l || echo "0")

          # Git info
          COMMIT=$(git log -1 --format='%h' -- ".opsera-vote3/k8s/overlays/${ENV}" 2>/dev/null || echo "N/A")

          echo "${ENV}_status=${SYNC}" >> $GITHUB_OUTPUT
          echo "${ENV}_pods=${PODS}" >> $GITHUB_OUTPUT
          echo "${ENV}_commit=${COMMIT}" >> $GITHUB_OUTPUT

  generate-report:
    name: "ðŸ“Š Generate Report"
    needs: [collect-metrics]
    runs-on: ubuntu-latest
    steps:
      - name: Generate Dashboard
        run: |
          echo "# ðŸ“Š vote3 Deployment Landscape" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Generated: $(date -u +'%Y-%m-%d %H:%M UTC')_" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Env | Strategy | ArgoCD | Pods |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|----------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | Rolling | ${{ needs.collect-metrics.outputs.dev_status }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | Canary | ${{ needs.collect-metrics.outputs.qa_status }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | Blue-Green | ${{ needs.collect-metrics.outputs.staging_status }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Vote URL | Result URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | https://vote-vote3-dev.agent.opsera.dev | https://result-vote3-dev.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | https://vote-vote3-qa.agent.opsera.dev | https://result-vote3-qa.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | https://vote-vote3-staging.agent.opsera.dev | https://result-vote3-staging.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Powered by Opsera Code-to-Cloud Enterprise v0.905_" >> $GITHUB_STEP_SUMMARY
