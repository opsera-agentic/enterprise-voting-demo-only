# ════════════════════════════════════════════════════════════════════════════════
# TEST JIRA INTEGRATION
# Standalone test to verify Jira ticket creation works
# Enhanced with quality-gate-failure test type for SonarQube integration testing
# ════════════════════════════════════════════════════════════════════════════════

name: "Test Jira Integration"

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of Jira ticket to create'
        type: choice
        options:
          - quality-gate-failure
          - security-vulnerability
          - deployment-failure
          - test-ticket
        default: 'quality-gate-failure'
      jira_url_override:
        description: 'Override JIRA_BASE_URL (leave empty to use secret)'
        type: string
        default: ''
      api_version:
        description: 'Jira API version'
        type: choice
        options:
          - '2'
          - '3'
        default: '2'
      auth_type:
        description: 'Authentication type'
        type: choice
        options:
          - basic
          - api-key
        default: 'api-key'
      mock_bugs:
        description: 'Mock bug count (quality-gate test)'
        type: string
        default: '5'
      mock_vulnerabilities:
        description: 'Mock vulnerability count (quality-gate test)'
        type: string
        default: '2'
      mock_code_smells:
        description: 'Mock code smell count (quality-gate test)'
        type: string
        default: '47'
      mock_coverage:
        description: 'Mock coverage % (quality-gate test)'
        type: string
        default: '42.5'
      mock_duplications:
        description: 'Mock duplication % (quality-gate test)'
        type: string
        default: '8.3'

jobs:
  test-jira:
    name: "Test Jira"
    runs-on: ubuntu-latest
    steps:
      - name: Check Jira Configuration
        id: check-jira
        run: |
          echo "### Jira Configuration Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          CONFIGURED="true"
          MISSING=""
          if [ -z "${{ secrets.JIRA_API_TOKEN }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_API_TOKEN"
            echo "JIRA_API_TOKEN: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "JIRA_API_TOKEN: Configured" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -z "${{ secrets.JIRA_EMAIL }}" ]; then
            echo "JIRA_EMAIL: Not configured (optional for api-key auth)" >> $GITHUB_STEP_SUMMARY
          else
            echo "JIRA_EMAIL: Configured" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -z "${{ secrets.JIRA_BASE_URL }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_BASE_URL"
            echo "JIRA_BASE_URL: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "JIRA_BASE_URL: Configured" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "configured=${CONFIGURED}" >> $GITHUB_OUTPUT
          if [ "$CONFIGURED" = "false" ]; then
            echo "Missing secrets:${MISSING}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Jira API Connection
        if: steps.check-jira.outputs.configured == 'true'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL_SECRET: ${{ secrets.JIRA_BASE_URL }}
          JIRA_URL_OVERRIDE: ${{ github.event.inputs.jira_url_override }}
          API_VERSION: ${{ github.event.inputs.api_version }}
          AUTH_TYPE: ${{ github.event.inputs.auth_type }}
        run: |
          if [ -n "$JIRA_URL_OVERRIDE" ]; then
            JIRA_BASE_URL="$JIRA_URL_OVERRIDE"
          else
            JIRA_BASE_URL="$JIRA_BASE_URL_SECRET"
          fi
          echo "### Testing Jira API Connection" >> $GITHUB_STEP_SUMMARY
          if [ "$AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi
          echo "**Target:** ${JIRA_BASE_URL}" >> $GITHUB_STEP_SUMMARY
          API_URL="${JIRA_BASE_URL}/rest/api/${API_VERSION}/project"
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "${AUTH_HEADER}" -H "Content-Type: application/json" "${API_URL}" 2>&1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          echo "**HTTP Code:** $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
          echo "HTTP Code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "API Connection: Success" >> $GITHUB_STEP_SUMMARY
            FIRST_PROJECT=$(echo "$BODY" | jq -r '.[0].key // "TEST"')
            echo "First project: $FIRST_PROJECT" >> $GITHUB_STEP_SUMMARY
            echo "JIRA_BASE_URL=${JIRA_BASE_URL}" >> $GITHUB_ENV
            echo "FIRST_PROJECT=${FIRST_PROJECT}" >> $GITHUB_ENV
          else
            echo "API Connection: Failed (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Response body: $BODY" >> $GITHUB_STEP_SUMMARY
            echo "::error::Jira API returned HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Create Test Jira Ticket
        if: steps.check-jira.outputs.configured == 'true'
        id: create-ticket
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          API_VERSION: ${{ github.event.inputs.api_version }}
          AUTH_TYPE: ${{ github.event.inputs.auth_type }}
          TEST_TYPE: ${{ github.event.inputs.test_type }}
          MOCK_BUGS: ${{ github.event.inputs.mock_bugs }}
          MOCK_VULNS: ${{ github.event.inputs.mock_vulnerabilities }}
          MOCK_SMELLS: ${{ github.event.inputs.mock_code_smells }}
          MOCK_COVERAGE: ${{ github.event.inputs.mock_coverage }}
          MOCK_DUPS: ${{ github.event.inputs.mock_duplications }}
        run: |
          echo "### Creating Test Jira Ticket" >> $GITHUB_STEP_SUMMARY
          if [ "$AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')
          PROJECT_KEY="${FIRST_PROJECT:-TEST}"
          echo "**Project:** ${PROJECT_KEY}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** ${TEST_TYPE}" >> $GITHUB_STEP_SUMMARY

          # Calculate tech debt
          TECH_DEBT_MINS=$((MOCK_SMELLS * 15))
          TECH_DEBT="${TECH_DEBT_MINS}m"

          case "$TEST_TYPE" in
            "quality-gate-failure")
              SUMMARY="[QUALITY] voting01-dev: ${MOCK_BUGS} bugs, ${MOCK_VULNS} vulns - Quality Gate Failed"
              ISSUE_TYPE="Bug"
              if [ "${MOCK_BUGS:-0}" -gt 0 ] || [ "${MOCK_VULNS:-0}" -gt 0 ]; then
                PRIORITY="Highest"
              else
                PRIORITY="High"
              fi
              DESCRIPTION="SonarQube quality gate check FAILED for voting01-dev.

          ===============================================
          QUALITY GATE STATUS: ERROR
          ===============================================

          FAILED CONDITIONS:
            * new_coverage: actual=${MOCK_COVERAGE} (threshold: 80.0)
            * new_bugs: actual=${MOCK_BUGS} (threshold: 0)
            * new_vulnerabilities: actual=${MOCK_VULNS} (threshold: 0)

          CODE METRICS:
            | Metric          | Value           |
            |-----------------|-----------------|
            | Bugs            | ${MOCK_BUGS}    |
            | Vulnerabilities | ${MOCK_VULNS}   |
            | Code Smells     | ${MOCK_SMELLS}  |
            | Coverage        | ${MOCK_COVERAGE}% |
            | Duplications    | ${MOCK_DUPS}%   |
            | Tech Debt       | ${TECH_DEBT}    |

          TOP ISSUES (127 total):
            * [CRITICAL] SQL Injection vulnerability (UserService.java:142)
            * [CRITICAL] Hardcoded credentials (DatabaseConfig.java:23)
            * [MAJOR] Null pointer dereference (ApiController.java:89)
            * [MAJOR] Resource leak (DataRepository.java:156)
            * [MAJOR] Cognitive complexity too high (OrderProcessor.java:234)
            * [MINOR] Missing @Override annotation (BaseHandler.java:67)

          ===============================================
          BUILD CONTEXT:
          ===============================================
            * Commit: ${{ github.sha }}
            * Branch: ${{ github.ref_name }}
            * Triggered by: ${{ github.actor }}
            * Timestamp: ${TIMESTAMP}

          LINKS:
            * SonarQube: https://sonarqube.example.com/dashboard?id=opsera-voting01
            * Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ===============================================
          RECOMMENDED ACTIONS:
          ===============================================
          1. Review the failed conditions above
          2. Click the SonarQube Dashboard link for details
          3. Fix issues: Bugs > Vulnerabilities > Code Smells
          4. Ensure coverage meets threshold
          5. Re-run pipeline after fixes

          ---
          TEST ticket from Jira integration test workflow."
              ;;
            "security-vulnerability")
              SUMMARY="[TEST-SECURITY] voting01-dev: 3 Critical, 5 High vulnerabilities"
              ISSUE_TYPE="Task"
              PRIORITY="High"
              DESCRIPTION="Test security vulnerability ticket.

          Security Scan Results (MOCK):
            | Service | Critical | High |
            |---------|----------|------|
            | Vote    | 1        | 2    |
            | Result  | 1        | 2    |
            | Worker  | 1        | 1    |
            | TOTAL   | 3        | 5    |

          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ---
          TEST ticket."
              ;;
            "deployment-failure")
              SUMMARY="[TEST-DEPLOY] voting01-dev Deployment Failed"
              ISSUE_TYPE="Task"
              PRIORITY="High"
              DESCRIPTION="Test deployment failure ticket.

          Deployment Details (MOCK):
            * Environment: dev
            * Image Tag: abc1234-20240115120000
            * Status: FAILED
            * Reason: Pod scheduling timeout

          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ---
          TEST ticket."
              ;;
            *)
              SUMMARY="[TEST] Jira Integration Test - ${TIMESTAMP}"
              ISSUE_TYPE="Task"
              PRIORITY="Medium"
              DESCRIPTION="Test ticket to verify Jira integration.

          Timestamp: ${TIMESTAMP}
          Triggered by: ${{ github.actor }}
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ---
          TEST ticket."
              ;;
          esac

          PAYLOAD=$(jq -n \
            --arg project "$PROJECT_KEY" \
            --arg summary "$SUMMARY" \
            --arg description "$DESCRIPTION" \
            --arg issuetype "$ISSUE_TYPE" \
            --arg priority "$PRIORITY" \
            '{"fields": {"project": {"key": $project}, "summary": $summary, "description": $description, "issuetype": {"name": $issuetype}, "priority": {"name": $priority}}}')

          echo "Sending request to: ${JIRA_BASE_URL}/rest/api/${API_VERSION}/issue"
          echo "Payload summary: $SUMMARY"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/${API_VERSION}/issue" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          ISSUE_KEY=$(echo "$BODY" | jq -r '.key // "FAILED"')

          if [ "$ISSUE_KEY" != "FAILED" ] && [ "$ISSUE_KEY" != "null" ] && [ "$HTTP_CODE" = "201" ]; then
            ISSUE_URL="${JIRA_BASE_URL}/browse/${ISSUE_KEY}"
            echo "Ticket Created: [${ISSUE_KEY}](${ISSUE_URL})" >> $GITHUB_STEP_SUMMARY
            echo "issue_key=${ISSUE_KEY}" >> $GITHUB_OUTPUT
            echo "issue_url=${ISSUE_URL}" >> $GITHUB_OUTPUT
          else
            echo "Failed to create ticket (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Response: $BODY" >> $GITHUB_STEP_SUMMARY
            echo "Payload: $PAYLOAD" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-jira.outputs.configured }}" != "true" ]; then
            echo "Result: Jira secrets not configured" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.create-ticket.outputs.issue_key }}" ]; then
            echo "Result: Jira integration working!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Result: Jira ticket creation failed" >> $GITHUB_STEP_SUMMARY
          fi
